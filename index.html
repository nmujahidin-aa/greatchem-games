<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Games</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="menu-container">
    <h1>Games</h1>
    <p id="uid-display">Loading user...</p>

    <div class="levels">
      <button onclick="startGame(1)" class="level-btn">Level 1<br><small>Katalis</small></button>
      <button id="level2" class="level-btn locked" onclick="startGame(2)">Level 2<br><small>Suhu</small></button>
      <button id="level3" class="level-btn locked" onclick="startGame(3)">Level 3<br><small>Konsentrasi</small></button>
      <button id="level4" class="level-btn locked" onclick="startGame(4)">Level 4<br><small>Luas Permukaan</small></button>
    </div>

    <footer></footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC1Fho5b99jL4-H4j_OFtSKmt8TV1X2PdM",
      authDomain: "greatchem12.firebaseapp.com",
      projectId: "greatchem12",
      storageBucket: "greatchem12.firebasestorage.app",
      messagingSenderId: "1083119029036",
      appId: "1:1083119029036:web:596c450f7ba58138767a89",
      measurementId: "G-MX4CCYK774"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ambil userId
    const params = new URLSearchParams(window.location.search);
    const userId = params.get("userId");

    document.getElementById("uid-display").innerText =
      userId ? `User ID: ${userId}` : "User ID tidak ditemukan";

    if (userId) localStorage.setItem("firebaseUserId", userId);

    // inisialisasi data user di firestore
    async function initUser() {
      if (!userId) return;
      const userRef = doc(db, "users", userId);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        // buat dokumen baru dengan default false
        await setDoc(userRef, {
          level1: false,
          level2: false,
          level3: false,
          level4: false,
        });
        return { level1: false, level2: false, level3: false, level4: false };
      }
      return snap.data();
    }

    // atur tampilan tombol berdasarkan progress
    function updateUI(levels) {
      const maxUnlocked = Object.values(levels).lastIndexOf(true) + 1;
      // jika semua false, hanya level 1 yang aktif
      let allowed = maxUnlocked === 0 ? 1 : maxUnlocked + 1;

      for (let i = 1; i <= 4; i++) {
        const btn = document.getElementById(`level${i}`);
        if (i <= allowed) {
          btn.classList.remove("locked");
          btn.onclick = () => window.startGame(i);
        } else {
          btn.classList.add("locked");
          btn.onclick = null;
        }
      }
    }

    // init
    (async () => {
      const levels = await initUser();
      if (levels) updateUI(levels);
    })();
  </script>
  <script>
    
    function startGame(level) {
      console.log(`Memulai game level ${level}`);

      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get("userId");

      if (!userId) {
        alert("User ID tidak ditemukan di URL!");
        return;
      }

      // pindah ke halaman puzzle dengan parameter level & userId
      window.location.href = `puzzle${level}.html?userId=${userId}`;
    }
    window.startGame = startGame;
  </script>
</body>
</html>
