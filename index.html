<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Games</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="menu-container">
    <h1>Games</h1>
    <p id="uid-display">Loading user...</p>

    <div class="levels">
      <button id="level1" class="level-btn">Level 1<br><small>Katalis</small></button>
      <button id="level2" class="level-btn locked">Level 2<br><small>Suhu</small></button>
      <button id="level3" class="level-btn locked">Level 3<br><small>Konsentrasi</small></button>
      <button id="level4" class="level-btn locked">Level 4<br><small>Luas Permukaan</small></button>
    </div>

    <footer></footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {
        const firebaseConfig = {
        apiKey: "AIzaSyC1Fho5b99jL4-H4j_OFtSKmt8TV1X2PdM",
        authDomain: "greatchem12.firebaseapp.com",
        projectId: "greatchem12",
        storageBucket: "greatchem12.firebasestorage.app",
        messagingSenderId: "1083119029036",
        appId: "1:1083119029036:web:596c450f7ba58138767a89",
        measurementId: "G-MX4CCYK774"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const userId = params.get("userId");

        document.getElementById("uid-display").innerText =
        userId ? `Mari selesaikan tantangan` : "Harap login";

        if (userId) {
        localStorage.setItem("firebaseUserId", userId);
        }

        function startGame(level) {
        console.log(`Memulai game level ${level}`);
        if (!userId) {
            showCustomAlert("User ID tidak ditemukan di URL!");
            return;
        }
        window.location.href = `puzzle${level}.html?userId=${userId}`;
        }

        async function initUser() {
        if (!userId) return;
        const userRef = doc(db, "users", userId);
        const snap = await getDoc(userRef);

        if (!snap.exists()) {
            await setDoc(userRef, {
            level1: false,
            level2: false,
            level3: false,
            level4: false,
            });
            return { level1: false, level2: false, level3: false, level4: false };
        }
        return snap.data();
        }

        function updateUI(levels) {
        for (let i = 1; i <= 4; i++) {
            const btn = document.getElementById(`level${i}`);
            if (i === 1) {
            btn.classList.remove("locked");
            btn.onclick = () => startGame(i);
            } else {
            if (levels[`level${i - 1}`]) {
                btn.classList.remove("locked");
                btn.onclick = () => startGame(i);
            } else {
                btn.classList.add("locked");
                btn.onclick = null;
            }
            }
        }
        }

        const levels = await initUser();
        if (levels) {
        updateUI(levels);
        }
    });
    </script>
</body>
</html>